<div id="widget-chat" >
    <button class="btn" onclick="cargarMensajes()">Actualizar</button>
    <table class="table table-hover">
        <tbody id="tablaCuerpo">
        </tbody>
    </table>
</div>

<div class="form-group">
    <label class="control-label col-sm-2" for="contenido">Mensaje Nuevo:</label>
    <div class="col-sm-10">
        <input type="text" class="form-control" name="contenido"
               placeholder="mensaje nuevo" id="contenido"/>
    </div>
</div>
<div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
        <button type="button" id="boton-enviar">Enviar</button>
    </div>
</div>


<script>
    var mensajes;
    //Funcion que carga los mensajes de un determinado chat
    function cargarMensajes(){
        $.ajax({
            url: URLbase + "/mensaje/" +idOferta + "/" + emailComprador,
            type: "GET",
            data: {
            },
            dataType: 'json',
            headers: { "token": token },
            success: function(respuesta) {
                mensajes = respuesta;
                actualizarTabla(mensajes);
            },
            error : function (error){
                $( "#contenedor-principal" ).load("widget-login.html");
            }
        });
    }
    //Funcion que actualiza los mensajes que salen en la tabla de determinado chat
    function actualizarTabla(mensajesMostrar){
        $( "#tablaCuerpo" ).empty(); // Vaciar la tabla
        for (i = 0; i < mensajesMostrar.length; i++) {
            $( "#tablaCuerpo" ).append(
                "<tr id="+mensajesMostrar[i]._id+">"+
                "<td> "+mensajesMostrar[i].emisor+":</td>" +
                "<td>"+mensajesMostrar[i].contenido+"</td>" +
                "<td>"+mensajesMostrar[i].fecha+"</td>" +
                "</tr>" );
        }
    }
    //Funcion que se ejecuta al clicar el boton para enviar un mensaje, envia el mensaje
    $("#boton-enviar").click(function(){
        $.ajax({
            url: URLbase + "/mensaje/agregar/"+ idOferta + "/" + emailComprador,
            type: "POST",
            data: {
                contenido : $("#contenido").val()
            },
            dataType : 'json',
            success : function(respuesta){
                actualizarTabla(respuesta);
                cargarMensajes();
                //Limpia el formulario despues de un mensaje
                $('input[type="text"]').val('');

            },
            error : function(error){
                $("#widget-login")
                    .prepend("<div class='alert alert-danger'>Usuario no identificado</div>");
            }
        });
    });


    cargarMensajes();
</script>